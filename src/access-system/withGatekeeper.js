import { gatekeeper } from "./index.js";

/**
 * –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ä–æ—É—Ç–∞.
 * –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–µ.
 */
export const withGatekeeper = (category, handler) => {
    return async (req, res, next) => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ res.json
        const originalJson = res.json.bind(res);

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º res.json, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –ü–ï–†–ï–î –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞
        res.json = async (body) => {
            try {
                // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç Guard –∏ –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π (–Ω–µ –æ—à–∏–±–∫–∞)
                if (req.gatekeeper && !body.error) {
                    // 1. –ê—Ç–æ–º–∞—Ä–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫—É –≤ –±–∞–∑–µ
                    await gatekeeper.consume(req.gatekeeper.key, category);
                    
                    // 2. –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Å—Ç–∞—Ç–∫–µ –≤ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
                    // (–ú—ã –±–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –∏–∑ Guard –∏ –≤—ã—á–∏—Ç–∞–µ–º 1)
                    if (body.meta) {
                        body.meta.remaining = req.gatekeeper.remaining - 1;
                    } else {
                        body.meta = { remaining: req.gatekeeper.remaining - 1 };
                    }
                    
                    console.log(`üé´ [Gatekeeper]: –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∞ –¥–ª—è ${req.gatekeeper.key} (${category})`);
                }
            } catch (consumeErr) {
                console.error("‚ùå [Gatekeeper] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–ø–∏—Å–∞–Ω–∏–∏:", consumeErr.message);
                // –ú—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤ –±–∞–∑–µ
            }

            // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π res.json —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–µ–ª–æ–º
            return originalJson(body);
        };

        try {
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–≤–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ —Ä–æ—É—Ç–∞
            await handler(req, res, next);
        } catch (err) {
            // –ï—Å–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –µ—ë –¥–∞–ª—å—à–µ (—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç)
            next(err);
        }
    };
};